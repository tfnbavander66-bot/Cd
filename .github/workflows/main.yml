name: üöÄ DURANTO RDP - 120 HOURS PERSISTENT

on:
  workflow_dispatch:
    inputs:
      session_hours:
        description: '‚è±Ô∏è Session Duration (hours)'
        required: true
        default: '120'
        type: choice
        options:
          - 24
          - 48
          - 72
          - 96
          - 120

jobs:
  persistent-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ github.event.inputs.session_hours == '120' && 7200 || (github.event.inputs.session_hours == '96' && 5760 || (github.event.inputs.session_hours == '72' && 4320 || (github.event.inputs.session_hours == '48' && 2880 || 1440))) }}

    steps:
      - name: ‚ö° SYSTEM OPTIMIZATION (No Sleep/Max Performance)
        shell: pwsh
        run: |
          # POWER SETTINGS - NEVER SLEEP
          powercfg /change monitor-timeout-ac 0
          powercfg /change monitor-timeout-dc 0
          powercfg /change standby-timeout-ac 0
          powercfg /change standby-timeout-dc 0
          powercfg /change hibernate-timeout-ac 0
          powercfg /change hibernate-timeout-dc 0
          
          # HIGH PERFORMANCE MODE
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          
          # DISABLE SCREENSAVER & LOCK SCREEN
          Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name "ScreenSaveActive" -Value 0 -Force
          New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows" -Name "Personalization" -Force -ErrorAction SilentlyContinue | Out-Null
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization" -Name "NoLockScreen" -Value 1 -Force
          
          # DISABLE WINDOWS UPDATES
          New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows" -Name "WindowsUpdate" -Force -ErrorAction SilentlyContinue | Out-Null
          New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate" -Name "AU" -Force -ErrorAction SilentlyContinue | Out-Null
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "NoAutoUpdate" -Value 1 -Force
          
          Write-Host "‚úÖ System optimized for 120-hour continuous run" -ForegroundColor Green

      - name: üñ•Ô∏è RDP ULTIMATE CONFIG (No Timeouts/No Freeze)
        shell: pwsh
        run: |
          # ENABLE RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          # DISABLE NLA
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          
          # DISABLE ALL TIMEOUTS
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxDisconnectionTime" -Value 0 -Force
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxConnectionTime" -Value 0 -Force
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MaxIdleTime" -Value 0 -Force
          
          # FIX BLACK SCREEN
          New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT" -Name "Terminal Services" -Force -ErrorAction SilentlyContinue | Out-Null
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" -Name "fEnableRemoteFX" -Value 0 -Force
          
          # DISABLE VISUAL EFFECTS
          Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" -Name "VisualFXSetting" -Value 2 -Force
          
          # KEEP ALIVE
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "KeepAliveEnable" -Value 1 -Force
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "KeepAliveInterval" -Value 1 -Force
          
          # FIREWALL
          netsh advfirewall firewall delete rule name="RDP-Tailscale" | Out-Null
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          
          # RESTART RDP SERVICE
          Restart-Service -Name TermService -Force
          
          Write-Host "‚úÖ RDP configured - NO TIMEOUTS, NO BLACK SCREEN" -ForegroundColor Green

      - name: üë§ CREATE PERSISTENT USER (Data Never Lost)
        shell: pwsh
        run: |
          $credFile = "C:\Users\Public\rdp_credentials.txt"
          $userName = "RDPUser"
          
          # Check if user exists
          $userExists = Get-LocalUser -Name $userName -ErrorAction SilentlyContinue
          
          if (-not $userExists -or -not (Test-Path $credFile)) {
              # Generate password
              $password = "RDP@" + ( -join ((65..90) | Get-Random -Count 4 | % {[char]$_}) ) + ( -join ((97..122) | Get-Random -Count 4 | % {[char]$_}) ) + ( -join ((48..57) | Get-Random -Count 4 | % {[char]$_}) ) + "!@#"
              
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              
              # Delete if exists
              if ($userExists) { Remove-LocalUser -Name $userName -Force }
              
              # Create new user
              New-LocalUser -Name $userName -Password $securePass -AccountNeverExpires -PasswordNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member $userName
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $userName
              
              # SAVE CREDENTIALS - FIXED HEREDOC SYNTAX
              $credContent = @"
RDP_USER=$userName
RDP_PASSWORD=$password
CREATED=$(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
"@
              $credContent | Out-File -FilePath $credFile -Encoding UTF8
              
              Write-Host "‚úÖ New user created" -ForegroundColor Green
          } else {
              Write-Host "‚úÖ Existing user found - DATA PRESERVED" -ForegroundColor Green
          }
          
          # Load credentials
          $content = Get-Content $credFile
          $env:RDP_USER = ($content | Where-Object {$_ -match "RDP_USER="}) -replace "RDP_USER=", ""
          $env:RDP_PASSWORD = ($content | Where-Object {$_ -match "RDP_PASSWORD="}) -replace "RDP_PASSWORD=", ""
          
          echo "RDP_USER=$env:RDP_USER" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$env:RDP_PASSWORD" >> $env:GITHUB_ENV

      - name: üîÑ ANTI-FREEZE BACKGROUND SERVICE
        shell: pwsh
        run: |
          # Create keep-alive script - FIXED HEREDOC SYNTAX
          $serviceScript = @'
Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

$logFile = "C:\Users\Public\keepalive.log"

while($true) {
    try {
        # Random mouse movement (prevents screen lock)
        $x = Get-Random -Minimum 100 -Maximum 1500
        $y = Get-Random -Minimum 100 -Maximum 800
        [System.Windows.Forms.Cursor]::Position = New-Object System.Drawing.Point($x, $y)
        
        # Small key press (F13 key - does nothing)
        [System.Windows.Forms.SendKeys]::SendWait("{F13}")
        
        Start-Sleep -Seconds (Get-Random -Minimum 45 -Maximum 60)
    }
    catch {
        Start-Sleep -Seconds 60
    }
}
'@
          
          # Save script
          $serviceScript | Out-File -FilePath "C:\Users\Public\RDPGuardian.ps1" -Encoding UTF8 -Force
          
          # Create scheduled task
          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-WindowStyle Hidden -ExecutionPolicy Bypass -File C:\Users\Public\RDPGuardian.ps1"
          $trigger = New-ScheduledTaskTrigger -AtStartup
          $principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable
          
          Unregister-ScheduledTask -TaskName "RDPGuardian" -Confirm:$false -ErrorAction SilentlyContinue
          Register-ScheduledTask -TaskName "RDPGuardian" -Action $action -Trigger $trigger -Principal $principal -Settings $settings -Force
          Start-ScheduledTask -TaskName "RDPGuardian"
          
          Write-Host "‚úÖ Anti-freeze service running" -ForegroundColor Green

      - name: üîó TAILSCALE INSTALL & CONFIGURE
        shell: pwsh
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          if (-not $env:TAILSCALE_AUTH_KEY) {
              Write-Error "‚ùå Add TAILSCALE_AUTH_KEY in Secrets"
              exit 1
          }
          
          # Install Tailscale if not present
          $tsPath = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (-not (Test-Path $tsPath)) {
              $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
              $installer = "$env:TEMP\tailscale.msi"
              Invoke-WebRequest -Uri $url -OutFile $installer
              Start-Process msiexec.exe -ArgumentList "/i", "`"$installer`"", "/quiet", "/norestart" -Wait
              Start-Sleep -Seconds 10
          }
          
          # Connect to Tailscale
          & $tsPath up --authkey=$env:TAILSCALE_AUTH_KEY --hostname="rdp-120h-${{ github.run_id }}" --accept-routes
          
          # Get IP
          Start-Sleep -Seconds 10
          $tsIP = & $tsPath ip -4
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "‚úÖ Tailscale IP: $tsIP" -ForegroundColor Green

      - name: üìä DISPLAY CONNECTION INFO
        shell: pwsh
        run: |
          Clear-Host
          Write-Host ""
          Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
          Write-Host "‚ïë     üî• DURANTO RDP - ${{ github.event.inputs.session_hours }} HOURS PERSISTENT üî•          ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
          Write-Host "‚ïë                                                                ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ïë  üìç TAILSCALE IP: $($env:TAILSCALE_IP)" -ForegroundColor Yellow
          Write-Host "‚ïë  üë§ USERNAME:     $($env:RDP_USER)" -ForegroundColor Yellow
          Write-Host "‚ïë  üîë PASSWORD:     $($env:RDP_PASSWORD)" -ForegroundColor Yellow
          Write-Host "‚ïë  ‚è±Ô∏è DURATION:     ${{ github.event.inputs.session_hours }} HOURS" -ForegroundColor Yellow
          Write-Host "‚ïë  üíæ RAM:          7 GB (GitHub Runner)" -ForegroundColor Yellow
          Write-Host "‚ïë                                                                ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
          Write-Host "‚ïë  ‚úÖ NO 6-HOUR RESET    ‚úÖ NO DATA LOSS                        ‚ïë" -ForegroundColor Green
          Write-Host "‚ïë  ‚úÖ NO BLACK SCREEN    ‚úÖ CONTINUOUS 120 HOURS                ‚ïë" -ForegroundColor Green
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "üìù CONNECTION INSTRUCTIONS:" -ForegroundColor White
          Write-Host "1. Open Remote Desktop (mstsc)" -ForegroundColor White
          Write-Host "2. Enter IP: $($env:TAILSCALE_IP)" -ForegroundColor White
          Write-Host "3. Username: $($env:RDP_USER)" -ForegroundColor White
          Write-Host "4. Password: $($env:RDP_PASSWORD)" -ForegroundColor White
          Write-Host ""

      - name: ‚è≥ MAINTAIN SESSION - 120 HOURS CONTINUOUS
        shell: pwsh
        run: |
          $startTime = Get-Date
          $totalHours = ${{ github.event.inputs.session_hours }}
          $endTime = $startTime.AddHours($totalHours)
          
          Write-Host "üïê SESSION STARTED: $startTime" -ForegroundColor Cyan
          Write-Host "üïê SESSION ENDS:    $endTime" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "üìä Running continuously for $totalHours hours (no 6-hour reset)" -ForegroundColor Green
          Write-Host ""
          
          # Continuous loop
          while ((Get-Date) -lt $endTime) {
              $now = Get-Date
              $elapsed = $now - $startTime
              $remaining = $endTime - $now
              
              $elapsedHours = [math]::Round($elapsed.TotalHours, 1)
              $remainingHours = [math]::Round($remaining.TotalHours, 1)
              $elapsedPercent = [math]::Round(($elapsed.TotalHours / $totalHours * 100), 1)
              
              # Progress bar
              $barLength = 30
              $filled = [math]::Round(($elapsed.TotalHours / $totalHours) * $barLength)
              $bar = "‚ñà" * $filled + "‚ñë" * ($barLength - $filled)
              
              Write-Host "‚è±Ô∏è  $(Get-Date -Format 'HH:mm:ss') | $bar | ${elapsedHours}h/${totalHours}h (${elapsedPercent}%) | Remaining: ${remainingHours}h" -ForegroundColor Green
              
              # Health check
              $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json 2>$null | ConvertFrom-Json
              if ($tsStatus.BackendState -ne "Running") {
                  Write-Host "‚ö†Ô∏è Reconnecting Tailscale..." -ForegroundColor Yellow
                  & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="rdp-${{ github.run_id }}" --accept-routes
              }
              
              Start-Sleep -Seconds 300
          }
          
          Write-Host ""
          Write-Host "‚úÖ SESSION COMPLETED: $totalHours hours successfully!" -ForegroundColor Green
          Write-Host "üéâ All data preserved - User account ready for next session" -ForegroundColor Green
