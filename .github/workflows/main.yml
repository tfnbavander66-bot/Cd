name: Duranto RDP - 120 HOURS PERSISTENT

on:
  workflow_dispatch:
    inputs:
      session_hours:
        description: 'â±ï¸ Session Duration (hours)'
        required: true
        default: '120'
        type: choice
        options:
          - 24
          - 48
          - 72
          - 96
          - 120

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ github.event.inputs.session_hours == '120' && 7200 || (github.event.inputs.session_hours == '96' && 5760 || (github.event.inputs.session_hours == '72' && 4320 || (github.event.inputs.session_hours == '48' && 2880 || 1440))) }}

    steps:
      - name: âš¡ System Optimization for 120 Hours
        shell: pwsh
        run: |
          # POWER SETTINGS - NO SLEEP
          powercfg /change monitor-timeout-ac 0
          powercfg /change standby-timeout-ac 0
          powercfg /change hibernate-timeout-ac 0
          
          # HIGH PERFORMANCE
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          
          # DISABLE WINDOWS UPDATES (Prevents auto-restart)
          New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Force | Out-Null
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "NoAutoUpdate" -Value 1 -Force
          
          Write-Host "âœ… System optimized for 120 hours" -ForegroundColor Green

      - name: Configure Core RDP Settings
        shell: pwsh
        run: |
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          
          # DISABLE ALL TIMEOUTS (Never disconnect)
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
                           -Name "MaxDisconnectionTime" -Value 0 -Force
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
                           -Name "MaxIdleTime" -Value 0 -Force
          
          # Firewall
          netsh advfirewall firewall delete rule name="RDP-Tailscale" | Out-Null
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389
          
          Restart-Service -Name TermService -Force
          Write-Host "âœ… RDP configured - No timeouts" -ForegroundColor Green

      - name: ðŸ”’ Create/Retrieve Persistent User (Data Never Lost)
        shell: pwsh
        run: |
          $credFile = "C:\Users\Public\rdp_credentials.txt"
          $userName = "RDPUser"
          
          # Check if user already exists
          $userExists = Get-LocalUser -Name $userName -ErrorAction SilentlyContinue
          
          if (-not $userExists -or -not (Test-Path $credFile)) {
              # Generate new password (same as your original function)
              function New-SecurePassword {
                  $charSets = @{
                      Upper   = [char[]](65..90)
                      Lower   = [char[]](97..122)
                      Number  = [char[]](48..57)
                      Special = [char[]](33,35,36,37,38,42,43,45,61,63,64,94,95)
                  }
                  $passwordChars = @()
                  $passwordChars += $charSets.Upper | Get-Random -Count 4
                  $passwordChars += $charSets.Lower | Get-Random -Count 4
                  $passwordChars += $charSets.Number | Get-Random -Count 4
                  $passwordChars += $charSets.Special | Get-Random -Count 4
                  $password = -join ($passwordChars | Sort-Object { Get-Random })
                  return $password
              }
              
              $password = New-SecurePassword
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              
              # Delete old user if exists
              if ($userExists) { Remove-LocalUser -Name $userName -Force }
              
              # Create new user
              New-LocalUser -Name $userName -Password $securePass -AccountNeverExpires -PasswordNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member $userName
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $userName
              
              # Save credentials to file (PERSISTENT)
              $credContent = @"
RDP_USER=$userName
RDP_PASSWORD=$password
CREATED_ON=$(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
"@
              $credContent | Out-File -FilePath $credFile -Encoding UTF8
              
              Write-Host "âœ… New user created with PERSISTENT credentials" -ForegroundColor Green
          } else {
              Write-Host "âœ… Existing user found - DATA PRESERVED" -ForegroundColor Green
          }
          
          # Load credentials
          $content = Get-Content $credFile
          $env:RDP_USER = ($content | Where-Object {$_ -match "RDP_USER="}) -replace "RDP_USER=", ""
          $env:RDP_PASSWORD = ($content | Where-Object {$_ -match "RDP_PASSWORD="}) -replace "RDP_PASSWORD=", ""
          
          echo "RDP_USER=$env:RDP_USER" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$env:RDP_PASSWORD" >> $env:GITHUB_ENV

      - name: Install Tailscale
        shell: pwsh
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
         
          try {
              Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -ErrorAction Stop
              Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -NoNewWindow
              Start-Sleep -Seconds 10
              Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
              Write-Host "Tailscale installed successfully"
          }
          catch {
              Write-Error "Tailscale installation failed: $($_.Exception.Message)"
              exit 1
          }

      - name: Establish Tailscale Connection
        shell: pwsh
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          if (-not $env:TAILSCALE_AUTH_KEY) {
              Write-Error "Tailscale auth key not found in secrets"
              exit 1
          }
          
          # Wait for Tailscale service
          $serviceReady = $false
          $retries = 0
          while (-not $serviceReady -and $retries -lt 10) {
              try {
                  $service = Get-Service -Name "Tailscale" -ErrorAction SilentlyContinue
                  if ($service -and $service.Status -eq "Running") {
                      $serviceReady = $true
                  } else {
                      Start-Service -Name "Tailscale" -ErrorAction SilentlyContinue
                      Start-Sleep -Seconds 5
                      $retries++
                  }
              }
              catch {
                  Start-Sleep -Seconds 5
                  $retries++
              }
          }
          
          # Connect to Tailscale
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=rdp-120h-${{ github.run_id }} --accept-routes
          
          # Get IP
          Start-Sleep -Seconds 10
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "Tailscale IP: $tsIP"

      - name: ðŸ”„ Anti-Freeze Background Service
        shell: pwsh
        run: |
          # Simple keep-alive script (prevents screen lock)
          $serviceScript = @'
          Add-Type -AssemblyName System.Windows.Forms
          while($true) {
              [System.Windows.Forms.Cursor]::Position = New-Object System.Drawing.Point((Get-Random 100 1000), (Get-Random 100 700))
              Start-Sleep -Seconds 45
          }
'@
          $serviceScript | Out-File -FilePath "C:\Users\Public\KeepAlive.ps1" -Encoding UTF8 -Force
          
          # Run in background
          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-WindowStyle Hidden -File C:\Users\Public\KeepAlive.ps1"
          $trigger = New-ScheduledTaskTrigger -AtStartup
          $principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
          Register-ScheduledTask -TaskName "KeepAlive" -Action $action -Trigger $trigger -Principal $principal -Force
          Start-ScheduledTask -TaskName "KeepAlive"
          
          Write-Host "âœ… Anti-freeze service running" -ForegroundColor Green

      - name: Verify RDP Accessibility
        shell: pwsh
        run: |
          Write-Host "Testing RDP connectivity..."
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -InformationLevel Quiet
          if (-not $testResult) {
              Write-Error "RDP port test failed"
              exit 1
          }
          Write-Host "âœ… RDP accessible"

      - name: Display Connection Information
        shell: pwsh
        run: |
          Clear-Host
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
          Write-Host "â•‘     ðŸ”¥ DURANTO RDP - ${{ github.event.inputs.session_hours }} HOURS PERSISTENT ðŸ”¥      â•‘" -ForegroundColor Green
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
          Write-Host "â•‘                                                            â•‘" -ForegroundColor Green
          Write-Host "â•‘  ðŸ“ TAILSCALE IP: $($env:TAILSCALE_IP)" -ForegroundColor Yellow
          Write-Host "â•‘  ðŸ‘¤ USERNAME:     $($env:RDP_USER)" -ForegroundColor Yellow
          Write-Host "â•‘  ðŸ”‘ PASSWORD:     $($env:RDP_PASSWORD)" -ForegroundColor Yellow
          Write-Host "â•‘  â±ï¸ DURATION:     ${{ github.event.inputs.session_hours }} HOURS" -ForegroundColor Yellow
          Write-Host "â•‘  ðŸ’¾ RAM:          7 GB (GitHub Runner)" -ForegroundColor Yellow
          Write-Host "â•‘                                                            â•‘" -ForegroundColor Green
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
          Write-Host "â•‘  âœ… NO 6-HOUR RESET    âœ… NO DATA LOSS                    â•‘" -ForegroundColor Green
          Write-Host "â•‘  âœ… NO BLACK SCREEN    âœ… CONTINUOUS 120 HOURS            â•‘" -ForegroundColor Green
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
          Write-Host ""

      - name: â³ Maintain Connection - 120 Hours Continuous
        shell: pwsh
        run: |
          $startTime = Get-Date
          $totalHours = ${{ github.event.inputs.session_hours }}
          $endTime = $startTime.AddHours($totalHours)
          
          Write-Host ""
          Write-Host "ðŸ“Š SESSION ACTIVE - $totalHours HOURS CONTINUOUS" -ForegroundColor Cyan
          Write-Host "Started: $startTime" -ForegroundColor Cyan
          Write-Host "Ends:    $endTime" -ForegroundColor Cyan
          Write-Host ""
          
          while ((Get-Date) -lt $endTime) {
              $now = Get-Date
              $elapsed = $now - $startTime
              $remaining = $endTime - $now
              
              $elapsedHours = [math]::Round($elapsed.TotalHours, 1)
              $remainingHours = [math]::Round($remaining.TotalHours, 1)
              
              Write-Host "â±ï¸  $(Get-Date -Format 'HH:mm:ss') | Elapsed: ${elapsedHours}h | Remaining: ${remainingHours}h | Status: ACTIVE" -ForegroundColor Green
              
              # Check Tailscale
              $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json 2>$null | ConvertFrom-Json
              if ($tsStatus.BackendState -ne "Running") {
                  & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="rdp-120h-${{ github.run_id }}" --accept-routes
              }
              
              Start-Sleep -Seconds 300  # Check every 5 minutes
          }
          
          Write-Host ""
          Write-Host "âœ… SESSION COMPLETED: $totalHours hours successfully!" -ForegroundColor Green
          Write-Host "ðŸŽ‰ All data preserved for next session!" -ForegroundColor Green
