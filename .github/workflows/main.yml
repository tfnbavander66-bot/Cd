name: Duranto RDP - 120 HOURS PERSISTENT

on:
  workflow_dispatch:
    inputs:
      session_hours:
        description: '‚è±Ô∏è Session Duration (hours)'
        required: true
        default: '120'
        type: choice
        options:
          - 24
          - 48
          - 72
          - 96
          - 120

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 7200

    steps:
      - name: ‚ö° System Optimization for 120 Hours
        shell: pwsh
        run: |
          # POWER SETTINGS - NO SLEEP
          powercfg /change monitor-timeout-ac 0
          powercfg /change monitor-timeout-dc 0
          powercfg /change standby-timeout-ac 0
          powercfg /change standby-timeout-dc 0
          powercfg /change hibernate-timeout-ac 0
          powercfg /change hibernate-timeout-dc 0
          
          # HIGH PERFORMANCE MODE
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          
          # DISABLE WINDOWS UPDATES (Prevents auto-restart)
          New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Force -ErrorAction SilentlyContinue | Out-Null
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "NoAutoUpdate" -Value 1 -Force
          
          # DISABLE SCREENSAVER
          Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name "ScreenSaveActive" -Value 0 -Force
          
          Write-Host "‚úÖ System optimized for 120-hour continuous run" -ForegroundColor Green

      - name: üñ•Ô∏è Configure Core RDP Settings (No Timeouts)
        shell: pwsh
        run: |
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          
          # Disable Network Level Authentication
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          
          # DISABLE ALL TIMEOUTS (Never disconnect)
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
                           -Name "MaxDisconnectionTime" -Value 0 -Force
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
                           -Name "MaxConnectionTime" -Value 0 -Force
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
                           -Name "MaxIdleTime" -Value 0 -Force
          
          # FIX BLACK SCREEN - Disable RemoteFX
          New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT" -Name "Terminal Services" -Force -ErrorAction SilentlyContinue | Out-Null
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" -Name "fEnableRemoteFX" -Value 0 -Force
          
          # Firewall rule
          netsh advfirewall firewall delete rule name="RDP-Tailscale" | Out-Null
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          # Restart RDP service
          Restart-Service -Name TermService -Force
          Write-Host "‚úÖ RDP configured - NO TIMEOUTS, NO BLACK SCREEN" -ForegroundColor Green

      - name: üë§ Create/Retrieve Persistent User (Data Never Lost)
        shell: pwsh
        run: |
          $credFile = "C:\Users\Public\rdp_credentials.txt"
          $userName = "RDPUser"
          
          # Check if user already exists
          $userExists = Get-LocalUser -Name $userName -ErrorAction SilentlyContinue
          
          if (-not $userExists -or -not (Test-Path $credFile)) {
              # Function to generate secure password
              function New-SecurePassword {
                  $charSets = @{
                      Upper   = [char[]](65..90)
                      Lower   = [char[]](97..122)
                      Number  = [char[]](48..57)
                      Special = [char[]](33,35,36,37,38,42,43,45,61,63,64,94,95)
                  }
                  $passwordChars = @()
                  $passwordChars += $charSets.Upper | Get-Random -Count 4
                  $passwordChars += $charSets.Lower | Get-Random -Count 4
                  $passwordChars += $charSets.Number | Get-Random -Count 4
                  $passwordChars += $charSets.Special | Get-Random -Count 4
                  $password = -join ($passwordChars | Sort-Object { Get-Random })
                  return $password
              }
              
              $password = New-SecurePassword
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              
              # Delete old user if exists
              if ($userExists) { Remove-LocalUser -Name $userName -Force }
              
              # Create new user
              New-LocalUser -Name $userName -Password $securePass -AccountNeverExpires -PasswordNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member $userName
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $userName
              
              # Save credentials to file (PERSISTENT)
              $credContent = @"
RDP_USER=$userName
RDP_PASSWORD=$password
CREATED_ON=$(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
"@
              $credContent | Out-File -FilePath $credFile -Encoding UTF8
              
              Write-Host "‚úÖ New user created with PERSISTENT credentials" -ForegroundColor Green
          } else {
              Write-Host "‚úÖ Existing user found - DATA PRESERVED" -ForegroundColor Green
          }
          
          # Load credentials from file
          $content = Get-Content $credFile
          $env:RDP_USER = ($content | Where-Object {$_ -match "RDP_USER="}) -replace "RDP_USER=", ""
          $env:RDP_PASSWORD = ($content | Where-Object {$_ -match "RDP_PASSWORD="}) -replace "RDP_PASSWORD=", ""
          
          echo "RDP_USER=$env:RDP_USER" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$env:RDP_PASSWORD" >> $env:GITHUB_ENV

      - name: üîó Install Tailscale
        shell: pwsh
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
         
          try {
              Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -ErrorAction Stop
              Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -NoNewWindow
              Start-Sleep -Seconds 10
              Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
              Write-Host "‚úÖ Tailscale installed successfully"
          }
          catch {
              Write-Error "Tailscale installation failed: $($_.Exception.Message)"
              exit 1
          }

      - name: üîå Establish Tailscale Connection
        shell: pwsh
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          if (-not $env:TAILSCALE_AUTH_KEY) {
              Write-Error "‚ùå Add TAILSCALE_AUTH_KEY in Secrets"
              exit 1
          }
          
          # Wait for Tailscale service
          $serviceReady = $false
          $retries = 0
          while (-not $serviceReady -and $retries -lt 10) {
              try {
                  $service = Get-Service -Name "Tailscale" -ErrorAction SilentlyContinue
                  if ($service -and $service.Status -eq "Running") {
                      $serviceReady = $true
                      Write-Host "Tailscale service is running"
                  } else {
                      Start-Service -Name "Tailscale" -ErrorAction SilentlyContinue
                      Start-Sleep -Seconds 5
                      $retries++
                  }
              }
              catch {
                  Start-Sleep -Seconds 5
                  $retries++
              }
          }
          
          # Connect to Tailscale
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=rdp-120h-${{ github.run_id }} --accept-routes
          
          # Get Tailscale IP
          Start-Sleep -Seconds 10
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "‚úÖ Tailscale IP: $tsIP" -ForegroundColor Green

      - name: üîÑ Anti-Freeze Background Service
        shell: pwsh
        run: |
          # Create keep-alive script
          $serviceScript = @'
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          
          while($true) {
              try {
                  # Random mouse movement (prevents screen lock)
                  $x = Get-Random -Minimum 100 -Maximum 1500
                  $y = Get-Random -Minimum 100 -Maximum 800
                  [System.Windows.Forms.Cursor]::Position = New-Object System.Drawing.Point($x, $y)
                  
                  # Small key press (F13 key - does nothing)
                  [System.Windows.Forms.SendKeys]::SendWait("{F13}")
                  
                  Start-Sleep -Seconds (Get-Random -Minimum 45 -Maximum 60)
              }
              catch {
                  Start-Sleep -Seconds 60
              }
          }
'@
          
          # Save script
          $serviceScript | Out-File -FilePath "C:\Users\Public\KeepAlive.ps1" -Encoding UTF8 -Force
          
          # Create scheduled task to run at startup
          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-WindowStyle Hidden -ExecutionPolicy Bypass -File C:\Users\Public\KeepAlive.ps1"
          $trigger = New-ScheduledTaskTrigger -AtStartup
          $principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable
          
          # Remove old task if exists
          Unregister-ScheduledTask -TaskName "KeepAlive" -Confirm:$false -ErrorAction SilentlyContinue
          
          # Register new task
          Register-ScheduledTask -TaskName "KeepAlive" -Action $action -Trigger $trigger -Principal $principal -Settings $settings -Force
          
          # Start now
          Start-ScheduledTask -TaskName "KeepAlive"
          
          Write-Host "‚úÖ Anti-freeze service running 24/7" -ForegroundColor Green

      - name: ‚úÖ Verify RDP Accessibility
        shell: pwsh
        run: |
          Write-Host "Testing RDP connectivity to Tailscale IP: $env:TAILSCALE_IP"
          
          # Test connectivity
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -InformationLevel Quiet
          if (-not $testResult) {
              Write-Error "TCP connection to RDP port 3389 failed"
              Get-Service TermService | Format-Table Name, Status
              exit 1
          }
          Write-Host "‚úÖ RDP is accessible!"

      - name: üìä Display Connection Information
        shell: pwsh
        run: |
          Clear-Host
          Write-Host ""
          Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
          Write-Host "‚ïë     üî• DURANTO RDP - ${{ github.event.inputs.session_hours }} HOURS PERSISTENT üî•          ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
          Write-Host "‚ïë                                                                ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ïë  üìç TAILSCALE IP: $($env:TAILSCALE_IP)" -ForegroundColor Yellow
          Write-Host "‚ïë  üë§ USERNAME:     $($env:RDP_USER)" -ForegroundColor Yellow
          Write-Host "‚ïë  üîë PASSWORD:     $($env:RDP_PASSWORD)" -ForegroundColor Yellow
          Write-Host "‚ïë  ‚è±Ô∏è DURATION:     ${{ github.event.inputs.session_hours }} HOURS" -ForegroundColor Yellow
          Write-Host "‚ïë  üíæ RAM:          7 GB (GitHub Runner)" -ForegroundColor Yellow
          Write-Host "‚ïë                                                                ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
          Write-Host "‚ïë  ‚úÖ NO 6-HOUR RESET    ‚úÖ NO DATA LOSS                        ‚ïë" -ForegroundColor Green
          Write-Host "‚ïë  ‚úÖ NO BLACK SCREEN    ‚úÖ CONTINUOUS 120 HOURS                ‚ïë" -ForegroundColor Green
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "üìù CONNECTION INSTRUCTIONS:" -ForegroundColor White
          Write-Host "1. Open Remote Desktop (mstsc)" -ForegroundColor White
          Write-Host "2. Enter IP: $($env:TAILSCALE_IP)" -ForegroundColor White
          Write-Host "3. Username: $($env:RDP_USER)" -ForegroundColor White
          Write-Host "4. Password: $($env:RDP_PASSWORD)" -ForegroundColor White
          Write-Host ""

      - name: ‚è≥ Maintain Connection - 120 Hours Continuous
        shell: pwsh
        run: |
          $startTime = Get-Date
          $totalHours = ${{ github.event.inputs.session_hours }}
          $endTime = $startTime.AddHours($totalHours)
          
          Write-Host ""
          Write-Host "üìä SESSION ACTIVE - $totalHours HOURS CONTINUOUS" -ForegroundColor Cyan
          Write-Host "Started: $startTime" -ForegroundColor Cyan
          Write-Host "Ends:    $endTime" -ForegroundColor Cyan
          Write-Host ""
          
          while ((Get-Date) -lt $endTime) {
              $now = Get-Date
              $elapsed = $now - $startTime
              $remaining = $endTime - $now
              
              $elapsedHours = [math]::Round($elapsed.TotalHours, 1)
              $remainingHours = [math]::Round($remaining.TotalHours, 1)
              $elapsedPercent = [math]::Round(($elapsed.TotalHours / $totalHours * 100), 1)
              
              # Progress bar
              $barLength = 30
              $filled = [math]::Floor(($elapsed.TotalHours / $totalHours) * $barLength)
              $bar = "‚ñà" * $filled + "‚ñë" * ($barLength - $filled)
              
              Write-Host "$(Get-Date -Format 'HH:mm:ss') | $bar | ${elapsedHours}h/${totalHours}h (${elapsedPercent}%) | Remaining: ${remainingHours}h" -ForegroundColor Green
              
              # Check Tailscale connection
              $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json 2>$null | ConvertFrom-Json -ErrorAction SilentlyContinue
              if (-not $tsStatus -or $tsStatus.BackendState -ne "Running") {
                  Write-Host "‚ö†Ô∏è Tailscale reconnecting..." -ForegroundColor Yellow
                  & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=rdp-120h-${{ github.run_id }} --accept-routes
              }
              
              Start-Sleep -Seconds 300  # Check every 5 minutes
          }
          
          Write-Host ""
          Write-Host "‚úÖ SESSION COMPLETED: $totalHours hours successfully!" -ForegroundColor Green
          Write-Host "üéâ All data preserved for next session!" -ForegroundColor Green
